---
redirect_from: /_posts/2024-12-01-%1
title: TSDB概念
tags:
  - 概念学习
  - aoway实习
---

## 什么是时间序列数据库(TSDB)？

Time series database 是一种数据库管理系统，用于存储、处理和分析时间序列数据（时序数据）。时序数据是种按时间顺序记录并索引的数据类型，例如股市数据、降雨的记录等。

### 时序数据有什么特点？

- 时间标注：每个数据点都带有时间戳，这个时间戳对于数据的计算和分析十分重要。
- 结构化：与来自网络爬虫、社交平台的海量数据不同，联网设备或监控系统生成的数据都是结构化的。这些数据都具有预定义的数据类型或固定长度，比如储能柜电表采集的负荷数据就可以用 4 字节的标准的浮点数来表示。
- 流式：数据源以近似恒定速率生成数据，例如储能柜每秒传输1次数据。这些数据流彼此独立，流量平稳可预测：尽管可能会因延迟而传输紊乱，但由于时间戳的存在，可以根据排序梳理数据，也排除了延迟的影响；与传统的社交媒体数据不同，时序数据的流量在一段时间内是稳定的，并且可以根据数据源的数量和采样周期来进行计算和预测。
- 不变性：时序数据一般都是 append-only，类似于日志数据，一般不容许而且也没有修改的必要。很少有场景，需要对采集的原始数据进行修改。

### 处理时序数据的困难？

- 时序数据量通常很大，1电表1秒传输1次数据，4个月传输的数据便可达到千万级别，还需考虑能源微网庞大的电表数。因此在执行存储、索引、查询、分析等操作时变得更加困难。
- 时序数据需要实时计算和分析，以便于实时检测异常并告警， 延迟可能会导致故障和业务影响。山东现货交易市场电力价格15分钟变化一次，而在高峰时段价格剧烈变动，对负荷和价格的短期预测也有更高的要求，日中的调动可能需要分钟级的实时数据支持。
- 通常需要关联来自不同传感器和其他源的数据，这使情况变得更复杂。不同的台区可能使用不同厂商的储能设备，使用不同的协议和数据类型。
- 不管是原始数据查询、还是聚合数据查询，时序数据的查询一般都会带上查询时间范围，一方面是根据时间范围计算聚合时间窗口，另一方面是为了更高效的检索数据，提高查询效率，避免大量无效数据的扫描。
- 数据在一段时间内的变化趋势比单个数据点重要得多。例如，考虑到网络不可靠性或传感器读数异常，可能会在一段时间内的某个平均值超过阈值时设置警报，而不是在单个数据点上这样做。即关注趋势，而非数值。

### 为什么需要时序数据库？

尽管我们可以使用关系数据库或 NoSQL 数据库来处理时序数据，但这类数据库并没有充分利用时序数据的特点，性能提升极为有限，只能依靠集群技术，投入更多的计算资源和存储资源来处理，系统的运营维护成本急剧上升。

- 时序数据数据量巨大，通用数据库并不是为处理这种规模的数据而设计的。关系数据库在非常大的数据集上表现很差，No SQL 数据库虽然解决了扩展能力，但是其通用的数据组织方式并不完全适用于对时序数据存储和查询需求，用户必须根据实际应用场景，进行特殊设计甚至大量数据冗余存储才能较好的利用资源处理请求。
- 随着数据量的增加，访问速度越来越慢。同时，大多数通用数据库为了提升查询性能，针对大量数据建立索引，由此消耗大量的系统资源。对于海量的时序数据，通用数据库无法高速加载并满足实时处理需求。
- 关系数据库和NoSQL没有针对时序数据的特别压缩方法，存储成本更高。

除了上述处理大数据集的效率问题，时序数据的应用还需要一些特殊功能。

- 插值：时间序列分布会在一些时间线上，且序列会随着时间的增长往后发展。本质上是在一个固定的时间点记录数据，但如果要检查某个具体时间的设备采集的某个量，而传感器实际采集的时间不是这个时间点，这就要求数据库能够根据相邻的数据点和规则对数据进行插值。负载数据有时还会因断电而缺失一段时间的数据。
- 连续查询：在时序应用的场景下，对于依照时间推进顺序写入的实时数据，用户有时会希望每隔一段固定时间，就能够按照一定的查询条件对该时间范围内的时序数据做一次计算（例如：对该时间范围内的数据求一次聚合计算），并将计算结果另行保存下来。因此，数据库需要提供连续查询（即一种简化的流计算能力），能够在时间窗口结束后对窗口内的数据进行计算。
- 窗口查询：时序数据常常需要根据采集时间对数据进行查询，本质上是在时间轴上划分出时间窗口，并对窗口内的数据进行聚合和查询计算。在实际生产应用中，业务场景要求的查询条件往往比这个更复杂，需要数据库能够按照不同规则、沿时间轴进行窗口划分，并对各个窗口内的时序数据分别进行聚合、选择计算等操作。例如，日前预测后进行日中的优化调度需要日中前几个小时内的数据进行分析。

专门构建的时序数据库充分利用了时序数据库的特点，大幅提升了数据的写入和查询速度，同时也大幅提高了数据压缩率。面对特殊需求，在通用数据库中，我们需要专门来编写这些功能。不同场景，不同数据量都需要不同的解决方案，麻烦且易出错。因此，无论数据集的大小如何，使用专门构建的时序数据库都不失为一个好的选择。

## InfluxDB与TDengine

公司使用[Redis](https://www.runoob.com/redis/redis-tutorial.html)存储，MySQL关系型数据库，[MongoDB](https://www.runoob.com/mongodb/mongodb-tutorial.html)(NoSQL)，以及InfluxDB与TDengine这两种时序数据库，基于上述的分析我更倾向于选用时序数据库，下面重点分析二者。

### InfluxDB

InfluxDB 使用 bucket、measurement 这两个核心概念，替代了关系数据库中database、table 等概念。
>InfluxDB 数据模型将时序数据组织为 bucket 和 measurement。一个 bucket 可以包含多个 measurement。measurement 可以包含多个标签和字段。

可以将 bucket 理解为存储时序数据的位置，我们可以为其指定时序数据的保存策略，measurement 则用于时序数据的逻辑分组。从逻辑意义上对比，我们可以把 bucket 看作关系数据库中的 database，把 measurement 看作 table。

measurement 包括几个部分：

- 标签（tag）：其值不经常改变的键值对。用来保存一些相对静态的信息，比如采集设备的主机、位置、站点等。
- 字段（field）：其值随着时间经常改变的键值对，比如温度、压强、股价等。
- 时间戳（timestamp）：与当前数据关联的时间戳。

在此基础上，InfluxDB 又有两个新的概念，point（数据点）和时间线（series），当然这在很多时序数据库中都是类似的。

整体来看，InfluxDB 的数据模型比较直观，而且不需要提前定义好模式，容易上手，后期如果有需要，动态增加新的字段也比较容易。当然，考虑后续的查询性能，在数据量非常大的情况下，也需要仔细设计 measurement 中的 tag 和 field。可以直接使用 InfluxDB 的图形界面或命令行客户端来创建 bucket，然后就可以利用行协议写入数据了。就像这样：

```InfluxQL
influx write \
  --bucket get-started \
  --precision s "
home,room=Living\ Room temp=21.1,hum=35.9,co=0i 1641024000
home,room=Kitchen temp=21.0,hum=35.9,co=0i 1641024000
home,room=Living\ Room temp=21.4,hum=35.9,co=0i 1641027600
home,room=Kitchen temp=23.0,hum=36.2,co=0i 1641027600
home,room=Living\ Room temp=21.8,hum=36.0,co=0i 1641031200
home,room=Kitchen temp=22.7,hum=36.1,co=0i 1641031200
home,room=Living\ Room temp=22.2,hum=36.0,co=0i 1641034800
"
```

在查询方面，InfluxDB 提供了类 SQL 的 InfluxQL 语言，后来又推出了函数式的脚本语言 Flux。需要一定的学习成本。

### TDengine

TDengine兼容 SQL，继承了 database、table 等概念，采用“一个数据采集点一张表”的数据模型,对每个数据采集点单独建一张表，用来存储这个数据采集点所采集的时序数据。

由于一个数据采集点一张表，导致表的数量巨增，难以管理，而且应用经常需要做采集点之间的聚合操作，聚合的操作也变得复杂起来。为解决这个问题，TDengine 引入了超级表（Super Table，STable）的概念。在 TDengine 的设计里，表用来代表一个具体的数据采集点，超级表用来代表一组相同类型的数据采集点集合。

在使用 TDengine 时，我们可以使用用 SQL 语法先创建库（database），再创建超级表，然后为具体的数据采集点创建子表。

总结而言，如果没有数据库相关背景，InfluxDB 上手比较直观；如果有 SQL 经验，则 TDengine 更为友好。